name: Build & Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Determine build config
        id: config
        env:
          HAS_SIGNING_SECRETS: ${{ secrets.CI_MACOS_CERTIFICATE_BASE64 != '' && secrets.CI_MACOS_CERTIFICATE_PASSWORD != '' && secrets.CI_MACOS_CERTIFICATE_ID != '' }}
          HAS_NOTARIZE_SECRETS: ${{ secrets.CI_MACOS_NOTARIZATION_USER != '' && secrets.CI_MACOS_NOTARIZATION_PASSWORD != '' && secrets.CI_MACOS_TEAM_ID != '' }}
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "codesign=${HAS_SIGNING_SECRETS}" >> "$GITHUB_OUTPUT"
            echo "notarize=${HAS_NOTARIZE_SECRETS}" >> "$GITHUB_OUTPUT"
            echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "codesign=${HAS_SIGNING_SECRETS}" >> "$GITHUB_OUTPUT"
            echo "notarize=false" >> "$GITHUB_OUTPUT"
            echo "version=0.0.0-dev" >> "$GITHUB_OUTPUT"
          else
            echo "codesign=false" >> "$GITHUB_OUTPUT"
            echo "notarize=false" >> "$GITHUB_OUTPUT"
            echo "version=0.0.0-dev" >> "$GITHUB_OUTPUT"
          fi

          if [[ "${HAS_SIGNING_SECRETS}" != "true" ]]; then
            echo "::warning::Signing secrets not configured â€” building unsigned app"
          fi

      - name: Setup signing
        if: steps.config.outputs.codesign == 'true'
        env:
          CERTIFICATE_BASE64: ${{ secrets.CI_MACOS_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CI_MACOS_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain"
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"

          echo "$CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"

          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"

          security import "$CERTIFICATE_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security \
            -T /usr/bin/xcrun

          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      - name: Build app bundle
        run: make app

      - name: Sign app
        if: steps.config.outputs.codesign == 'true'
        env:
          CODESIGN_IDENTITY: ${{ secrets.CI_MACOS_CERTIFICATE_ID }}
        run: |
          codesign --force --deep --options runtime --timestamp \
            --sign "$CODESIGN_IDENTITY" \
            --entitlements resources/entitlements.plist \
            build/Microscope.app

      - name: Create DMG
        run: bash scripts/create_dmg.sh

      - name: Sign DMG
        if: steps.config.outputs.codesign == 'true'
        env:
          CODESIGN_IDENTITY: ${{ secrets.CI_MACOS_CERTIFICATE_ID }}
        run: |
          codesign --force --timestamp \
            --sign "$CODESIGN_IDENTITY" \
            build/Microscope.dmg

      - name: Notarize
        if: steps.config.outputs.notarize == 'true'
        env:
          APPLE_ID: ${{ secrets.CI_MACOS_NOTARIZATION_USER }}
          APPLE_PASSWORD: ${{ secrets.CI_MACOS_NOTARIZATION_PASSWORD }}
          TEAM_ID: ${{ secrets.CI_MACOS_TEAM_ID }}
        run: |
          xcrun notarytool store-credentials "microscope-notarize" \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$APPLE_PASSWORD"

          xcrun notarytool submit build/Microscope.dmg \
            --keychain-profile "microscope-notarize" \
            --wait

          xcrun stapler staple build/Microscope.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Microscope-${{ steps.config.outputs.version }}-macos-arm64
          path: build/Microscope.dmg

      - name: Create release
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          mv build/Microscope.dmg "build/Microscope-${VERSION}-macos-arm64.dmg"
          gh release create "$GITHUB_REF_NAME" \
            --title "Microscope $VERSION" \
            --generate-notes \
            "build/Microscope-${VERSION}-macos-arm64.dmg"

      - name: Cleanup keychain
        if: always()
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain"
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi
